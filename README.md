# Passkey Wallet - Stacks Builder Challenge

A WebAuthn/Passkey-based smart contract wallet on Stacks blockchain using Clarity 4, featuring Hiro Chainhooks integration for real-time event monitoring.

[![Clarity Version](https://img.shields.io/badge/Clarity-4-blue)](https://docs.stacks.co/clarity)
[![Network](https://img.shields.io/badge/Network-Testnet-green)](https://explorer.hiro.so)
[![Chainhooks](https://img.shields.io/badge/Chainhooks-Integrated-purple)](https://www.npmjs.com/package/@hirosystems/chainhooks-client)

## ğŸ¯ Stacks Builder Challenge

This project is built for the **Stacks Builder Challenge** and tracks the following metrics:

- âœ… **Hiro Chainhooks Integration** - Real-time event monitoring for wallet activities
- ğŸ“Š **User Activity** - Tracks unique users and wallet registrations
- ğŸ’° **Fee Generation** - Monitors transaction fees generated by the contract
- ğŸ”— **GitHub Contributions** - Open-source development in public repository

The leaderboard updates daily based on:
- Use of Hiro Chainhooks in the app
- Users and fees generated by smart contracts
- GitHub contributions to public repos

## ğŸš€ Quick Start for AI Agents

### Contract Information
- **Network**: Stacks Testnet
- **Contract Address**: `SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet`
- **Deployment TX**: `d5ec4a16bd07dc281681245acc9def4c2b068e71fe4c3da934a96ffa70902c8a`
- **Explorer**: [View on Explorer](https://explorer.hiro.so/txid/SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet?chain=testnet)

### Quick Interaction
```bash
# Monitor contract events (uses Chainhooks)
npm run monitor

# Interact with contract
npm run interact

# Deploy to testnet
npm run deploy

# Run tests
npm test
```

## ğŸ“‹ Table of Contents

- [Features](#features)
- [Smart Contract Details](#smart-contract-details)
- [Hiro Chainhooks Integration](#hiro-chainhooks-integration)
- [Installation](#installation)
- [Usage](#usage)
- [API Reference](#api-reference)
- [For AI Agents](#for-ai-agents)
- [Architecture](#architecture)
- [Testing](#testing)
- [Deployment](#deployment)
- [Contributing](#contributing)

## âœ¨ Features

### Core Functionality
- ğŸ” **WebAuthn/Passkey Authentication** - Secure authentication using secp256r1-verify (Clarity 4)
- ğŸ’¼ **Multi-Signature Wallet** - Add multiple signers to wallets
- ğŸ’° **STX Deposits & Withdrawals** - Secure asset management
- ğŸ“œ **Transaction History** - Complete audit trail
- ğŸ”” **Event Emission** - Real-time activity monitoring

### Clarity 4 Features
- âœ… Uses `as-contract?` with explicit asset allowances
- âœ… Native `secp256r1-verify` for WebAuthn signatures
- âœ… Modern error handling with response types
- âœ… Optimized for epoch 3.3

### Chainhooks Integration
- ğŸ“¡ Real-time event monitoring
- ğŸ“Š Automatic statistics tracking
- ğŸ¯ Custom predicates for deposits, withdrawals, registrations
- ğŸ’¾ Event logging and reporting

## ğŸ“œ Smart Contract Details

### Public Functions

#### `register-wallet`
Register a new passkey-based wallet.

```clarity
(register-wallet
  (wallet-id (buff 32))
  (public-key-x (buff 32))
  (public-key-y (buff 32))
  (metadata (string-ascii 256)))
```

**Returns**: `(response bool uint)`

#### `deposit`
Deposit STX into a registered wallet.

```clarity
(deposit
  (wallet-id (buff 32))
  (amount uint))
```

**Returns**: `(response uint uint)` - Amount deposited

#### `withdraw`
Withdraw STX with passkey signature verification.

```clarity
(withdraw
  (wallet-id (buff 32))
  (amount uint)
  (recipient principal)
  (message-hash (buff 32))
  (signature (buff 64)))
```

**Returns**: `(response uint uint)` - Amount withdrawn

#### `add-signer`
Add additional signer to wallet (multi-sig).

```clarity
(add-signer
  (wallet-id (buff 32))
  (new-signer principal))
```

**Returns**: `(response bool uint)`

### Read-Only Functions

#### `get-wallet`
Retrieve wallet information.

```clarity
(get-wallet (wallet-id (buff 32)))
```

#### `get-balance`
Get wallet balance.

```clarity
(get-balance (wallet-id (buff 32)))
```

#### `get-transaction`
Get specific transaction details.

```clarity
(get-transaction
  (wallet-id (buff 32))
  (tx-index uint))
```

### Events

The contract emits the following events for Chainhooks monitoring:

```clarity
// Wallet registered
{event: "wallet_registered", wallet-id: ..., owner: ..., timestamp: ...}

// Deposit made
{event: "deposit", wallet-id: ..., amount: ..., sender: ...}

// Withdrawal executed
{event: "withdraw", wallet-id: ..., amount: ..., recipient: ..., verified: true}
```

## ğŸ”— Hiro Chainhooks Integration

This project uses **[Hiro Chainhooks](https://www.npmjs.com/package/@hirosystems/chainhooks-client)** for real-time blockchain event monitoring.

### What are Chainhooks?

Chainhooks allow you to:
- Monitor specific contract events in real-time
- Track user activity and transaction metrics
- Build responsive dApps with instant updates
- Generate analytics for the Builder Challenge

### Chainhook Predicates

Located in `chainhooks/predicates.json`:

1. **Deposit Events** - Monitors all STX deposits
2. **Withdrawal Events** - Tracks withdrawals and verifications
3. **Registration Events** - New wallet registrations
4. **Contract Calls** - All contract interactions

### Running the Monitor

```bash
# Run the chainhook monitor
npm run monitor

# Or directly
node chainhooks/monitor.js
```

The monitor will:
- âœ… Fetch and parse contract events
- âœ… Calculate statistics (users, fees, volume)
- âœ… Generate reports for Builder Challenge
- âœ… Save data to `CHAINHOOK-REPORT.json`

### Sample Output

```
ğŸ” PASSKEY WALLET CHAINHOOK MONITOR
======================================================================
Contract: SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet
Network: testnet
======================================================================

ğŸ“Š Fetching contract events...
âœ… Found 15 events

ğŸ”” DEPOSIT
   TX: 0x123...
   Time: 2025-12-17T02:30:00.000Z
   Amount: 10.000000 STX
   Sender: ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM

ğŸ“ˆ STATISTICS (For Stacks Builder Challenge)
======================================================================
Total Deposits:        5
Total Withdrawals:     2
Total Registrations:   3
Total Volume:          50.000000 STX
Unique Users:          4
Total Fees Generated:  0.015000 STX
======================================================================
```

## ğŸ’» Installation

```bash
# Clone repository
git clone <your-repo-url>
cd passkey-wallet

# Install dependencies
npm install

# Copy environment template
cp .env.example .env

# Edit .env with your configuration
nano .env
```

### Prerequisites

- Node.js 18+
- Clarinet 3.11.0+
- Stacks CLI (optional)

## ğŸ® Usage

### 1. Deploy Contract

```bash
npm run deploy
```

This will:
- Generate a deployment wallet
- Fund it from testnet faucet (if needed)
- Deploy the contract to Stacks testnet
- Save deployment details to `DEPLOYMENT-SUCCESS.json`

### 2. Interact with Contract

```bash
npm run interact
```

Available interactions:
- Register a new wallet
- Deposit STX
- Withdraw with signature verification
- Add signers
- Query wallet data

### 3. Monitor Events

```bash
npm run monitor
```

Monitors blockchain events and generates statistics for the Builder Challenge.

### 4. Run Tests

```bash
npm test
```

Runs the Clarinet test suite.

## ğŸ¤– For AI Agents

### Key Files for Discovery

1. **`PROJECT-METADATA.json`** - Complete project metadata and structure
2. **`DEPLOYMENT-SUCCESS.json`** - Live deployment information
3. **`README.md`** - This documentation
4. **`contracts/passkey-wallet.clar`** - Smart contract source
5. **`scripts/interact.js`** - Interaction examples
6. **`chainhooks/monitor.js`** - Event monitoring

### How to Interact Programmatically

```javascript
const { StacksTestnet } = require('@stacks/network');
const { makeContractCall, broadcastTransaction } = require('@stacks/transactions');

const network = STACKS_TESTNET;
const contractAddress = 'SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R';
const contractName = 'passkey-wallet';

// Example: Call deposit function
const txOptions = {
  contractAddress,
  contractName,
  functionName: 'deposit',
  functionArgs: [
    bufferCV(walletId),  // buff 32
    uintCV(1000000)      // 1 STX in micro-STX
  ],
  senderKey: privateKey,
  network,
  anchorMode: AnchorMode.Any
};

const transaction = await makeContractCall(txOptions);
const broadcastResponse = await broadcastTransaction({transaction, network});
```

### Querying Contract State

```bash
# Using Stacks API
curl https://api.testnet.hiro.so/v2/contracts/call-read/SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R/passkey-wallet/get-balance \
  -H 'Content-Type: application/json' \
  -d '{"arguments": ["0x...wallet-id..."]}'
```

## ğŸ—ï¸ Architecture

```
passkey-wallet/
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ passkey-wallet.clar          # Main smart contract (Clarity 4)
â”œâ”€â”€ chainhooks/
â”‚   â”œâ”€â”€ predicates.json              # Chainhook event predicates
â”‚   â””â”€â”€ monitor.js                   # Event monitoring script
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ interact.js                  # Contract interaction examples
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ passkey-wallet_test.clar     # Contract tests
â”œâ”€â”€ settings/
â”‚   â”œâ”€â”€ Devnet.toml                  # Local network config
â”‚   â”œâ”€â”€ Simnet.toml                  # Simulation network config
â”‚   â””â”€â”€ Testnet.toml                 # Testnet config
â”œâ”€â”€ deploy.js                        # Deployment script
â”œâ”€â”€ PROJECT-METADATA.json            # Project metadata (AI-readable)
â”œâ”€â”€ DEPLOYMENT-SUCCESS.json          # Deployment details
â”œâ”€â”€ CHAINHOOK-REPORT.json            # Event monitoring report
â”œâ”€â”€ .env.example                     # Environment template
â””â”€â”€ README.md                        # This file
```

## ğŸ§ª Testing

```bash
# Run all tests
clarinet test

# Check contract syntax
clarinet check

# Run in console (REPL)
clarinet console
```

### Test Coverage

- âœ… Wallet registration
- âœ… Deposit functionality
- âœ… Withdrawal with signature verification
- âœ… Multi-signature operations
- âœ… Access control
- âœ… Error handling

## ğŸš¢ Deployment

### Testnet Deployment

The contract is already deployed to testnet:

- **Address**: `SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet`
- **TX**: `d5ec4a16bd07dc281681245acc9def4c2b068e71fe4c3da934a96ffa70902c8a`
- **Explorer**: [View Contract](https://explorer.hiro.so/txid/SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet?chain=testnet)

### Mainnet Deployment

```bash
# Generate mainnet deployment plan
clarinet deployments generate --mainnet

# Review the plan
cat deployments/default.mainnet-plan.yaml

# Deploy (requires funding)
clarinet deployments apply --mainnet
```

## ğŸ“Š Builder Challenge Metrics

This project tracks:

### Chainhooks Usage âœ…
- 4 active chainhook predicates
- Real-time event monitoring
- Automated reporting

### User Metrics ğŸ“ˆ
- Unique wallet registrations
- Active users (deposits/withdrawals)
- Multi-sig participants

### Fee Generation ğŸ’°
- Transaction fees tracked
- Volume metrics
- Contract interaction stats

### GitHub Activity ğŸ”—
- Open-source repository
- Regular commits
- Documentation updates

View live metrics:
```bash
npm run monitor
cat CHAINHOOK-REPORT.json
```

## ğŸ” Security

- âœ… WebAuthn/Passkey authentication (secp256r1)
- âœ… Multi-signature support
- âœ… Transaction verification
- âœ… Access control checks
- âœ… Explicit asset allowances (Clarity 4)
- âš ï¸ **Testnet Only** - Not audited for mainnet

## ğŸ“ License

MIT License - see LICENSE file for details

## ğŸ¤ Contributing

Contributions welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Add tests for new features
4. Submit a pull request

## ğŸ“ Support

- **Documentation**: See this README and PROJECT-METADATA.json
- **Issues**: GitHub Issues
- **Stacks Docs**: https://docs.stacks.co
- **Chainhooks Docs**: https://www.npmjs.com/package/@hirosystems/chainhooks-client

## ğŸ–ï¸ Acknowledgments

- Built for **Stacks Builder Challenge**
- Uses **Hiro Chainhooks** for event monitoring
- Powered by **Clarity 4** smart contracts
- Deployed on **Stacks Testnet**

---

**For AI Agents**: All contract details, deployment information, and interaction methods are documented in `PROJECT-METADATA.json`. The contract is live on testnet and ready for programmatic interaction. Use `scripts/interact.js` as a reference for building transactions.

**Contract Address**: `SP1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRCBGD7R.passkey-wallet`

**Last Updated**: 2025-12-17
